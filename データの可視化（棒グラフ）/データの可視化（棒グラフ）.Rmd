---
title: "データの可視化（棒グラフ）"
date: "`r Sys.Date()`"
author: Sort
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(warning = F,
                      message = F,
                      comment = "",
                      fig.align = "center")
```

この記事のコードをまとめたものは[Github](https://github.com/FruitGranola?tab=repositories)にあります。

# 使用するパッケージ

```{r}
library(tidyverse)
library(magrittr)
```

# ggplot2 の theme をあらかじめ設定しておく

最初からthemeを設定しておく。これがかなり大事だ。（当たり前体操）
おすすめは`theme_minimal()`だ。シンプルで、これが一番見やすい。（n=1）

```{r}
theme_set(theme_minimal(base_size = 15))
```

# データの読み込み

今回使用するのは衆院選に出馬した各候補者のデータだ。
1996年から2017年までのデータが詰まっている。

```{r}
data <- read_csv("Data/House_of_Councilors_1996_2017.csv") # 1996年～2017年までの衆院選データ
```

# データ内の変数名を確認する

どんな変数があるか見てみよう。

```{r}
names(data)
```

# 今回使用したい形にデータを変形

今回は当選者数を可視化する。そのため、棒グラフで使いやすい形にする。
また、2005年の衆院選にデータの範囲を絞る。

```{r}
data %<>% 
  group_by(year, party_jpn) %>% # 年ごと、各政党ごとに処理を行う
  summarise(smd = sum(smd)) %>%  # 各政党の当選者数を計算
  filter(party_jpn %in% c("自民党", "民主党", "公明党")) # 政党を絞る

data_2005 <- data %>% filter(year == 2005) # 2005年のデータに絞る
```

# 棒グラフ

## なんの変哲もない棒グラフ

```{r}
data_2005 %>% 
  ggplot(aes(x = party_jpn, y = smd)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数")
```

## y が大きい順に x を並べる

より見やすい棒グラフを作るのに、大きい順や小さい順に並び変えることは非常に有効だ。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T), # fct_reorder(x, y, .desc = T)でyが大きい順にxを並び変える
             y = smd)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") 
```

## 棒グラフに y の値のラベルを付ける

大きい順や小さい順に並び変えても細かい数値が読み取れるわけではない。
そのため、ラベルを付けるとより見やすい棒グラフになる。
また、`paste()`を使うと数値の後に単位を付けられる。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),
             y = smd)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")), # 棒グラフに当選者数のラベルを付ける
             position = position_stack(vjust = 0.5), # ラベルの位置 
             size = 8) # ラベルのサイズ
```

## 特定の棒の色を変える

図の中に、視線を集中させたい棒がある場合は色を活用しよう。
有彩色と無彩色で色分けをすると、有彩色で棒を強調することができる。
まずは、注目させたいものを1、それ以外を0とするダミー変数を作成する。

```{r}
# 色を変える対象を1とするダミー変数を作成する
data_2005 %<>% mutate(ldp = if_else(party_jpn == "自民党", 1, 0))
```

今回は赤とグレーで色分けしてみた。
`scale_fill_manual()`で自由に色を選べる。
ただ、勝手にラベルの色も変わるので、`geom_label()`に追加で設定が必要となる。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd,
             fill = factor(ldp))) + # ldpの値で色を変える。
  geom_bar(stat = "identity", show.legend = F) + # show.legend = Fでlegendを非表示に
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")),                                  
             size = 8,                                                          
             position = position_stack(vjust = 0.5),                            
             color = "black", # ラベルの枠の色
             fill = "white") + # ラベルの背景の色
  scale_fill_manual(values = c("grey","red")) # ldp = 1はred、 ldp = 0はgreyで棒グラフを塗る
```

# gghighlightを使った場合

簡単に図形の強調をするパッケージとして`gghighlight`がある。
ただ、`geom_label()`で数値のラベルを付けたいときには相性が悪い。
相手に見せる資料には上のやり方が良いだろう。

```{r}
library(gghighlight)
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd,
             fill = party_jpn)) + # ldpの値で色を変える。
  geom_bar(stat = "identity", show.legend = F) + # show.legend = Fでlegendを非表示に
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  gghighlight(party_jpn %in% c("自民党")) 
```


## 描画範囲の設定

棒グラフの上のほうが詰まりすぎると見えづらいことがある。
また、ラベルを棒の上に付けると見切れることがある。そういうときは描画範囲を調整する。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd,
             fill = factor(ldp))) +
  geom_bar(stat = "identity", show.legend = F) + 
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(y = smd + 20, label = paste(round(smd, 1), "人", sep = "")),                                  
             size = 8,                            
             color = "black",
             fill = "white") +
  scale_fill_manual(values = c("grey","red")) + 
  coord_trans(ylim = c(0, 250)) # y軸を0～250まで表示する
```

## メモリ（x）の操作(カテゴリカル)

xがカテゴリカル変数の場合、このような工夫で図を分かりやすくできる。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd)) +
  geom_bar(aes(fill = factor(ldp)), stat = "identity", show.legend = F) +       
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")),                                  
             size = 8,                                                          
             position = position_stack(vjust = 0.5),                            
             color = "black",                                                   
             fill = "white") +                                                  
  scale_fill_manual(values = c("grey","red")) + 
  scale_x_discrete(labels = c("自民党" = "自民党\n(346人)", # 自民党を自民党\n(候補者数)に
                              "民主党" = "民主党\n(299人)", # 民主党を民主党\n(候補者数)に
                              "公明党" = "公明党\n(52人)")) # 公民党を公民党\n(候補者数)に
```

## メモリ（y）の操作(数量)

メモリの刻みを増やしたり、メモリの範囲を制限したりできる。
あくまでもメモリの調整なので、`xlim()`や`ylim()`とは別物だ。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd)) +
  geom_bar(aes(fill = factor(ldp)), stat = "identity", show.legend = F) +       
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")),                                  
             size = 8,                                                          
             position = position_stack(vjust = 0.5),                            
             color = "black",                                                   
             fill = "white") +                                                  
  scale_fill_manual(values = c("grey","red")) + 
  scale_x_discrete(labels = c("自民党" = "自民党\n(346人)", 
                              "民主党" = "民主党\n(299人)", 
                              "公明党" = "公明党\n(52人)")) + 
  scale_y_continuous(breaks = seq(0, 220, length = 12)) #  y軸のメモリを0～220までにし、12本のメモリ線を引く
```

## 棒グラフを回転する

xが増えると文字が重なって見えにくくなる。文字の角度を変えてもいいが、視認性が低下する。
そのため、グラフを回転することをおすすめする。

```{r}
data_2005 %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),                  
             y = smd)) +
  geom_bar(aes(fill = factor(ldp)), stat = "identity", show.legend = F) +       
  labs(x = "", y = "当選者数", title = "2005年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")),                                  
             size = 8,                                                          
             position = position_stack(vjust = 0.5),                            
             color = "black",                                                   
             fill = "white") +                                                  
  scale_fill_manual(values = c("grey","red")) + 
  scale_x_discrete(labels = c("自民党" = "自民党\n(346人)", 
                              "民主党" = "民主党\n(299人)", 
                              "公明党" = "公明党\n(52人)")) + 
  scale_y_continuous(breaks = seq(0, 220, length = 12)) + 
  coord_flip() # coord_flip()で図形を回転させる。ylimを設定することで描画範囲を設定可能
```

## 実施年毎の棒グラフ

`facet_wrap()`を使用するときは`theme_bw()`のほうが視認性が高いと思っているため、勝手に推奨してます。
ただ、時系列データのようなものは、素直に折れ線グラフを使ったほうが見やすい。

```{r}
data %>% 
  ggplot(aes(x = fct_reorder(party_jpn, smd, .desc = T),
             y = smd)) +
  geom_bar(aes(fill = party_jpn), stat = "identity") +
  labs(x = "", y = "当選者数", title = "1996～2017年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = "")), 
             position = position_stack(vjust = 0.5),
             size = 3) + 
  theme_bw(base_size = 15) +
  theme(legend.position = c(.85, .09), legend.title = element_blank()) +
  facet_wrap(~ year) 
```

## 積み上げ棒グラフ

正直、積み上げ棒グラフ使うより、折れ線グラフの方が視認性が高いよね。  
使用は非推奨です。

```{r}
data %>% 
  ggplot(aes(x = fct_reorder(as.factor(year), year, .desc = F),
             y = smd)) +
  geom_bar(aes(fill = party_jpn), stat = "identity") +
  labs(x = "実施年", y = "当選者数", title = "1996～2017年衆院選: 各政党の当選者数") +
  geom_label(aes(label = paste(round(smd, 1), "人", sep = ""), group = party_jpn),
             size = 3,
             position = position_stack(vjust = 0.5)) +
  theme(legend.position = c(.06, .8), legend.title = element_blank())
```

